<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶é“¶å° - VPN Distribution System</title>
    <link rel="stylesheet" href="/static/css/style-v3.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Shared Styles */
    </style>
</head>

<body>
    <nav class="payment-nav">
        <div class="nav-content">
            <a href="/dashboard" class="nav-brand">
                <div class="nav-logo">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" />
                    </svg>
                </div>
                <span class="nav-title">VPN Distribution</span>
            </a>
        </div>
    </nav>

    <main class="payment-main">
        <div class="payment-container">
            <!-- Payment Card -->
            <div class="payment-card" id="paymentCard">
                <div class="payment-header">
                    <div class="payment-title">æ”¶é“¶å°</div>
                    <div class="payment-amount" id="paymentAmount">Â¥0.00</div>
                </div>
                <div class="payment-body">
                    <div class="order-info">
                        <div class="order-info-row">
                            <span class="order-info-label">è®¢å•å·</span>
                            <span class="order-info-value" id="orderNumber">-</span>
                        </div>
                        <div class="order-info-row">
                            <span class="order-info-label">å•†å“åç§°</span>
                            <span class="order-info-value" id="planName">-</span>
                        </div>
                        <div class="order-info-row">
                            <span class="order-info-label">æµé‡</span>
                            <span class="order-info-value" id="planTraffic">-</span>
                        </div>
                        <div class="order-info-row">
                            <span class="order-info-label">å‘¨æœŸ</span>
                            <span class="order-info-value" id="planPeriod">-</span>
                        </div>
                    </div>

                    <div class="payment-methods">
                        <div class="payment-tab active" data-method="alipay" onclick="selectPayment('alipay')">
                            <div class="payment-tab-icon">ğŸ’³</div>
                            <div class="payment-tab-label">æ”¯ä»˜å®</div>
                        </div>
                        <div class="payment-tab" data-method="wechat" onclick="selectPayment('wechat')">
                            <div class="payment-tab-icon">ğŸ’š</div>
                            <div class="payment-tab-label">å¾®ä¿¡æ”¯ä»˜</div>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-code" id="qrCode">
                            <div class="qr-placeholder">åŠ è½½ä¸­...</div>
                        </div>
                        <p class="payment-hint">
                            è¯·ä½¿ç”¨<span id="paymentMethod">æ”¯ä»˜å®</span>æ‰«æäºŒç»´ç æ”¯ä»˜<br>
                            <strong>å¤‡æ³¨è®¢å•å·å6ä½ï¼š<span id="orderLast6">-</span></strong>
                        </p>
                    </div>

                    <div class="contact-info">
                        æ”¯ä»˜åè¯·è”ç³»å®¢æœå¼€é€šï¼š<strong id="adminContact">-</strong>
                    </div>
                </div>

                <div class="payment-actions">
                    <button class="btn btn-secondary" onclick="window.history.back()">è¿”å›</button>
                    <button class="btn btn-primary" onclick="checkPaymentStatus()">æˆ‘å·²æ”¯ä»˜</button>
                    <button class="btn btn-primary"
                        style="background: var(--cyber-gradient-secondary); margin-left:10px;"
                        onclick="simulateInstantPay()">æ¨¡æ‹Ÿè‡ªåŠ¨æ”¯ä»˜</button>
                </div>
            </div>

            <!-- Checking State -->
            <div class="payment-card" id="checkingCard" style="display: none;">
                <div class="checking-container">
                    <div class="spinner"></div>
                    <h3 class="success-title">ç¡®è®¤æ”¯ä»˜çŠ¶æ€</h3>
                    <p class="success-desc">æ­£åœ¨ç¡®è®¤æ”¯ä»˜çŠ¶æ€ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>

            <!-- Success State -->
            <div class="payment-card" id="successCard" style="display: none;">
                <div class="payment-header">
                    <div class="payment-title">æ”¯ä»˜æˆåŠŸ</div>
                </div>
                <div class="success-container">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                    </div>
                    <h3 class="success-title">æ”¯ä»˜æˆåŠŸï¼</h3>
                    <p class="success-desc">æ‚¨çš„VPNå·²å¼€é€šï¼Œè®¢é˜…ä¿¡æ¯å·²å‘é€åˆ°æ‚¨çš„è´¦æˆ·</p>
                    <button class="btn btn-primary" onclick="window.location.href='/dashboard'"
                        style="margin-top: var(--cyber-spacing-lg);">
                        è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentOrderId = null;
        let currentMethod = 'alipay';
        let statusCheckInterval = null;

        function getOrderIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('order');
        }

        function selectPayment(method) {
            currentMethod = method;
            document.querySelectorAll('.payment-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            const methodNames = { alipay: 'æ”¯ä»˜å®', wechat: 'å¾®ä¿¡' };
            document.getElementById('paymentMethod').textContent = methodNames[method];

            // åˆ‡æ¢æ—¶é‡æ–°åŠ è½½äºŒç»´ç ï¼ˆå‘èµ·æ”¯ä»˜è¯·æ±‚ï¼‰
            initiateHupijiaoPay();
        }

        async function initiateHupijiaoPay() {
            const qrCode = document.getElementById('qrCode');
            qrCode.innerHTML = '<div class="qr-placeholder">æ­£åœ¨ç”ŸæˆäºŒç»´ç ...</div>';

            try {
                const result = await API.payment.hupijiaoPay(currentOrderId);
                if (result.code === 0 && result.data.url_qrcode) {
                    qrCode.innerHTML = `<img src="${result.data.url_qrcode}" alt="æ”¯ä»˜äºŒç»´ç " style="max-width:200px">`;
                    // å¦‚æœæœ‰è·³è½¬é“¾æ¥ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªè¾…åŠ©æŒ‰é’®
                    if (result.data.url) {
                        const hint = document.querySelector('.payment-hint');
                        hint.innerHTML += `<br><a href="${result.data.url}" target="_blank" style="color: var(--cyber-primary); font-size: 0.8rem; text-decoration: underline;">æ— æ³•æ‰«ç ï¼Ÿç‚¹å‡»æ­¤å¤„è·³è½¬æ”¯ä»˜</a>`;
                    }
                } else {
                    showPlaceholder();
                }
            } catch (e) {
                console.error('Hupijiao Pay error:', e);
                showPlaceholder();
            }
        }

        function showPlaceholder() {
            const methodNames = { alipay: 'æ”¯ä»˜å®', wechat: 'å¾®ä¿¡' };
            document.getElementById('qrCode').innerHTML = `<div class="qr-placeholder">${methodNames[currentMethod]}æ”¯ä»˜å‘èµ·å¤±è´¥<br>è¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ</div>`;
        }

        async function loadOrderInfo() {
            currentOrderId = getOrderIdFromUrl();
            if (!currentOrderId) {
                alert('è®¢å•IDä¸å­˜åœ¨');
                window.location.href = '/shop';
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payment/order/${currentOrderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.code === 0) {
                    const data = result.data;
                    document.getElementById('paymentAmount').textContent = `Â¥${data.amount.toFixed(2)}`;
                    document.getElementById('orderNumber').textContent = data.order_number;
                    document.getElementById('planName').textContent = data.plan_name;
                    document.getElementById('planTraffic').textContent = `${data.plan_traffic} GB`;
                    document.getElementById('orderLast6').textContent = data.order_number.slice(-6);

                    const periodNames = {
                        '1month': '1ä¸ªæœˆ',
                        '3month': '3ä¸ªæœˆ',
                        '6month': '6ä¸ªæœˆ',
                        '1year': '1å¹´',
                        'onetime': 'æ°¸ä¹…'
                    };
                    document.getElementById('planPeriod').textContent = periodNames[data.plan_period] || data.plan_period;
                    document.getElementById('adminContact').textContent = data.contact;

                    loadQRCode(currentMethod);
                } else {
                    alert(result.message);
                    window.location.href = '/shop';
                }
            } catch (error) {
                console.error('åŠ è½½è®¢å•ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½è®¢å•ä¿¡æ¯å¤±è´¥');
                window.location.href = '/shop';
            }
        }

        async function checkPaymentStatus() {
            document.getElementById('paymentCard').style.display = 'none';
            document.getElementById('checkingCard').style.display = 'block';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payment/status/${currentOrderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();

                if (result.code === 0) {
                    const status = result.data.status;

                    if (status === 'completed') {
                        showSuccess(result.data);
                    } else if (status === 'verifying') {
                        alert('æ”¯ä»˜å‡­è¯å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸å¼€é€š');
                        document.getElementById('checkingCard').style.display = 'none';
                        document.getElementById('paymentCard').style.display = 'block';
                    } else {
                        await submitPaymentProof();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
                alert('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥');
                document.getElementById('checkingCard').style.display = 'none';
                document.getElementById('paymentCard').style.display = 'block';
            }
        }

        async function simulateInstantPay() {
            if (!currentOrderId) return;
            const btn = document.querySelector('button[onclick="simulateInstantPay()"]');
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨æ”¯ä»˜...';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/payment/instant-pay/${currentOrderId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();
                if (result.code === 0) {
                    showSuccess(result.data);
                } else {
                    alert(result.message || 'å³æ—¶æ”¯ä»˜å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            } finally {
                btn.disabled = false;
                btn.innerText = 'æ¨¡æ‹Ÿè‡ªåŠ¨æ”¯ä»˜';
            }
        }

        async function submitPaymentProof() {
            const transactionId = prompt('è¯·è¾“å…¥æ”¯ä»˜å®/å¾®ä¿¡äº¤æ˜“å·ï¼š');
            if (!transactionId) {
                document.getElementById('checkingCard').style.display = 'none';
                document.getElementById('paymentCard').style.display = 'block';
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/payment/submit-proof', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        order_id: parseInt(currentOrderId),
                        payment_method: currentMethod,
                        transaction_id: transactionId
                    })
                });
                const result = await response.json();

                if (result.code === 0) {
                    alert('æ”¯ä»˜å‡­è¯å·²æäº¤ï¼è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸å¼€é€šã€‚');
                    startStatusPolling();
                } else {
                    alert(result.message);
                    document.getElementById('checkingCard').style.display = 'none';
                    document.getElementById('paymentCard').style.display = 'block';
                }
            } catch (error) {
                console.error('æäº¤æ”¯ä»˜å‡­è¯å¤±è´¥:', error);
                alert('æäº¤æ”¯ä»˜å‡­è¯å¤±è´¥');
                document.getElementById('checkingCard').style.display = 'none';
                document.getElementById('paymentCard').style.display = 'block';
            }
        }

        function startStatusPolling() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            statusCheckInterval = setInterval(async () => {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/payment/status/${currentOrderId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const result = await response.json();

                    if (result.code === 0 && result.data.status === 'completed') {
                        clearInterval(statusCheckInterval);
                        showSuccess(result.data);
                    }
                } catch (error) {
                    console.error('è½®è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
                }
            }, 5000);
        }

        function showSuccess(data) {
            document.getElementById('checkingCard').style.display = 'none';
            document.getElementById('paymentCard').style.display = 'none';
            document.getElementById('successCard').style.display = 'block';

            if (data && data.subscription && data.subscription.vless_url) {
                const sub = data.subscription;
                const successContainer = document.querySelector('.success-container');
                const nodeInfo = document.createElement('div');
                nodeInfo.style.marginTop = '20px';
                nodeInfo.style.textAlign = 'left';
                nodeInfo.innerHTML = `
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">ä»£ç†èŠ‚ç‚¹é“¾æ¥ (VLESS):</p>
                    <div style="background: #f4f4f4; padding: 12px; border-radius: 8px; word-break: break-all; font-size: 0.8rem; border: 1px solid #ddd; margin-bottom: 12px; font-family: monospace;">
                        ${sub.vless_url}
                    </div>
                    <button class="btn btn-primary" style="width: 100%; height: 40px; font-size: 0.9rem;" onclick="navigator.clipboard.writeText('${sub.vless_url}').then(() => alert('èŠ‚ç‚¹é“¾æ¥å·²å¤åˆ¶ï¼'))">
                        å¤åˆ¶èŠ‚ç‚¹åˆ°å‰ªè´´æ¿
                    </button>
                `;
                // Insert before the "Back to Dashboard" button
                const backBtn = successContainer.querySelector('button');
                successContainer.insertBefore(nodeInfo, backBtn);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadOrderInfo();
            startStatusPolling(); // é¡µé¢åŠ è½½åç«‹å³å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
        });

        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        });
    </script>
</body>

</html>